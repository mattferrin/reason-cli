#!/usr/bin/env bash

export ESY__STORE_VERSION=3.x.x

    STRLEN_RESULT=0
    strLen() {
      oLang=$LANG
      LANG=C
      STRLEN_RESULT=${#1}
      LANG=$oLang
    }
    printError() {
      echo >&2 "ERROR:";
      echo >&2 "$0 command is not installed correctly. ";
      TROUBLESHOOTING="When installing <package_name>, did you see any errors in the log? "
      TROUBLESHOOTING="$TROUBLESHOOTING - What does (which <binary_name>) return? "
      TROUBLESHOOTING="$TROUBLESHOOTING - Please file a github issue on <package_name>'s repo."
      echo >&2 "$TROUBLESHOOTING";
    }

if [ -z ${REASON_CLI__ENVIRONMENTSOURCED__UTOP+x} ]; then
  if [ -z ${REASON_CLI__ENVIRONMENTSOURCED+x} ]; then
    # In windows this woudl be: a simple: %~dp0
    SOURCE="${BASH_SOURCE[0]}"
    while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
      SCRIPTDIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
      SOURCE="$(readlink "$SOURCE")"
      [[ $SOURCE != /* ]] && SOURCE="$SCRIPTDIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
    done
    SCRIPTDIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
    export ESY_EJECT__SANDBOX="$SCRIPTDIR/../rel"
    export PACKAGE_ROOT="$SCRIPTDIR/.."
    # Remove dependency on esy and package managers in general
    # We fake it so that the eject store is the location where we relocated the
    # binaries to.
    export ESY_EJECT__STORE=`cat $PACKAGE_ROOT/records/recordedClientInstallStorePath.txt`
    ENV_PATH="$ESY_EJECT__SANDBOX/node_modules/.cache/_esy/build-eject/eject-env"
    source "$ENV_PATH"
    export REASON_CLI__ENVIRONMENTSOURCED="sourced"
    export REASON_CLI__ENVIRONMENTSOURCED__UTOP="sourced"
  fi
  command -v $0 >/dev/null 2>&1 || {
    printError;
    exit 1;
  }

  if [ "$1" == "----where" ]; then
     which "utop"
  else
    exec "utop" $@
  fi
  
else
  printError;
  exit 1;
fi
